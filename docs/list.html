---
layout: default
title: Resources
---

<h1>Resources</h1>

<div style="margin:12px 0;">
  <input id="q" placeholder="キーワード / tag を入力（例: diffusion, llm）" style="padding:8px;width:100%;max-width:480px;border:1px solid #ddd;border-radius:6px;">
</div>

<div style="margin:8px 0;">
  <select id="sort">
    <option value="updated_desc">更新が新しい順</option>
    <option value="score_desc">スコアが高い順</option>
    <option value="name_asc">名前順</option>
  </select>
  <select id="type"><option value="">すべての種類</option></select>
  <select id="license"><option value="">すべてのライセンス</option></select>
</div>

<div id="quickTags" style="margin:8px 0;"></div>

<div style="opacity:.75;font-size:.9em;margin:6px 0;">
  <span id="count">0 items</span>
  <span id="status" style="margin-left:12px;"></span>
</div>

<div id="list"></div>

<div style="margin:16px 0;">
  <button id="prev">Prev</button>
  <button id="next">Next</button>
  <span id="pageInfo" style="margin-left:8px;"></span>
</div>

<script>
(() => {
  // ====== 設定 ======
  const DATA_URL = './resources.json';             // ← 同階層を明示（先頭スラッシュ禁止）
  const PAGE_SIZE = 48;

  // ====== 要素 ======
  const el = s => document.getElementById(s);
  const q = el('q'), sortSel = el('sort'), typeSel = el('type'), licenseSel = el('license');
  const quick = el('quickTags'), list = el('list'), count = el('count');
  const prev = el('prev'), next = el('next'), pageInfo = el('pageInfo'), status = el('status');

  // ====== 状態 ======
  let raw = [], filtered = [], page = 1, activeTags = new Set();

  // ====== ユーティリティ ======
  const esc = s => (s ?? '').toString()
      .replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const toDate = s => s ? (s+'').slice(0,10) : '';

  const send = (name, props={}) => { try { if (window.plausible) plausible(name, {props}); } catch(_e){} };

  // 上位タグ（license: と dataset: は除外）
  function topTags(data, n=20){
    const freq = new Map();
    for (const x of data) for (const t of (x.tags||[])) {
      if (t.startsWith('license:') || t.startsWith('dataset:')) continue;
      freq.set(t, (freq.get(t)||0) + 1);
    }
    return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n).map(([t])=>t);
  }

  function buildFilters(data){
    // type
    const tset = new Set(data.map(d=>d.type).filter(Boolean));
    for (const t of [...tset].sort()) {
      const o = document.createElement('option'); o.value = t; o.textContent = t; typeSel.appendChild(o);
    }
    // license
    const lset = new Set();
    for (const d of data) for (const t of (d.tags||[])) if (t.startsWith('license:')) lset.add(t.slice(8));
    for (const l of [...lset].sort()) {
      const o = document.createElement('option'); o.value = l; o.textContent = l; licenseSel.appendChild(o);
    }
    // quick tags
    quick.innerHTML = '';
    for (const t of topTags(data)) {
      const a = document.createElement('a');
      a.textContent = t; a.href = 'javascript:void(0)';
      a.style = 'display:inline-block;margin:2px 6px 2px 0;padding:2px 6px;border:1px solid #ddd;border-radius:999px;font-size:.9em;';
      a.onclick = () => { activeTags.has(t) ? activeTags.delete(t) : activeTags.add(t); render(); send('TagFilter',{tag:t}); };
      quick.appendChild(a);
    }
  }

  // スコア計算（stars/downloads に対数、最近更新ボーナス）
  function score(x){
    const s = Number(x['stars/downloads']||0);
    const star = Math.log10(Math.max(1, s));
    let bonus = 0;
    try{
      const u = x.updated_at ? new Date(x.updated_at) : null;
      if (u) {
        const diff = (Date.now() - u.getTime())/86400000; // days
        if (diff <= 30) bonus = 0.6;
      }
    }catch(_e){}
    return +(star + bonus).toFixed(3);
  }

  function applyFilters(){
    const text = q.value.trim().toLowerCase();
    const t = typeSel.value, lic = licenseSel.value;
    filtered = raw.filter(x=>{
      if (t && x.type !== t) return false;
      if (lic && !(x.tags||[]).includes('license:'+lic)) return false;
      if (activeTags.size){
        for (const tag of activeTags){ if (!(x.tags||[]).includes(tag)) return false; }
      }
      if (text){
        const hay = [x.id, x.name, x.description, ...(x.tags||[])].join(' ').toLowerCase();
        if (!hay.includes(text)) return false;
      }
      return true;
    });

    // sort
    const how = sortSel.value;
    for (const x of filtered) x._score = score(x);
    if (how === 'updated_desc') filtered.sort((a,b)=>String(b.updated_at).localeCompare(String(a.updated_at)));
    else if (how === 'score_desc') filtered.sort((a,b)=>b._score - a._score);
    else if (how === 'name_asc') filtered.sort((a,b)=>String(a.id).localeCompare(String(b.id)));

    // ページ調整
    const maxPage = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
    page = Math.min(page, maxPage);

    count.textContent = `${filtered.length.toLocaleString()} items`;
    pageInfo.textContent = `${page} / ${maxPage}`;
    prev.disabled = page <= 1;
    next.disabled = page >= maxPage;
  }

  function card(x){
    const tags = (x.tags||[]).map(t=>`<span style="display:inline-block;margin:2px 6px 2px 0;padding:2px 6px;border:1px solid #ddd;border-radius:999px;font-size:.85em;">${esc(t)}</span>`).join(' ');
    const kind = esc(x.type || '');
    const open = esc(x.url || x.homepage || '#');
    return `
      <div class="card" style="margin:12px;padding:12px;border:1px solid #e5e5e5;border-radius:8px;">
        <div style="display:flex;align-items:baseline;gap:8px;flex-wrap:wrap;">
          <div style="font-weight:700;font-size:1.15em;">${esc(x.id || x.name)}</div>
          ${kind ? `<span style="opacity:.8;border:1px solid #ddd;border-radius:6px;padding:2px 6px;font-size:.85em;">${kind}</span>` : ''}
          <span style="opacity:.8;">score: ${x._score ?? score(x)}</span>
          <span style="opacity:.8;">・更新: ${esc(toDate(x.updated_at))}</span>
        </div>
        <div style="margin:6px 0 8px;">${esc(x.description || '')}</div>
        <div style="margin:6px 0;">${tags}</div>
        ${open && open !== '#' ? `<a href="${open}" target="_blank" rel="noopener" onclick="try{plausible && plausible('Open',{props:{id:'${esc(x.id)}'}})}catch(e){}">Open</a>` : ''}
      </div>`;
  }

  function render(){
    applyFilters();
    const start = (page-1)*PAGE_SIZE;
    const chunk = filtered.slice(start, start+PAGE_SIZE);
    list.innerHTML = chunk.map(card).join('') || '<div style="margin:12px;opacity:.7;">No items.</div>';
  }

  // ====== イベント ======
  let timer;
  q.addEventListener('input', () => {
    clearTimeout(timer);
    timer = setTimeout(() => { page = 1; render(); send('Search',{q:q.value}); }, 200);
  });
  sortSel.onchange = () => { render(); send('Select',{sort:sortSel.value}); };
  typeSel.onchange = () => { page = 1; render(); send('Select',{type:typeSel.value}); };
  licenseSel.onchange = () => { page = 1; render(); send('Select',{license:licenseSel.value}); };
  prev.onclick = () => { if (page>1){ page--; render(); } };
  next.onclick = () => { page++; render(); };

  // ====== ロード ======
  (async function init(){
    status.textContent = 'Loading...';
    try{
      const res = await fetch(DATA_URL + '?v=' + Date.now(), {cache:'no-store'});
      if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
      raw = await res.json();
      buildFilters(raw);
      render();
      status.textContent = '';
    }catch(e){
      console.error(e);
      status.textContent = '読み込みエラー: ' + e.message;
      list.innerHTML = '<div style="margin:12px;color:#b00;">resources.json を取得できませんでした。パスまたは公開状況を確認してください。</div>';
    }
  })();
})();
</script>