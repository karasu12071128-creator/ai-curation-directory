---
layout: default
title: Home
---

<div class="card">
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <input id="q" placeholder="キーワード / tag（例: diffusion, llm）" size="32">
    <select id="sort">
      <option value="date-desc">更新が新しい順</option>
      <option value="date-asc">更新が古い順</option>
      <option value="score-desc">スコア高い順</option>
      <option value="score-asc">スコア低い順</option>
      <option value="title-asc">タイトルA→Z</option>
      <option value="title-desc">タイトルZ→A</option>
    </select>
    <select id="type">
      <option value="">すべての種類</option>
      <option value="hf_model">hf_model</option>
      <option value="hf_space">hf_space</option>
      <option value="github_repo">github_repo</option>
    </select>
    <select id="license">
      <option value="">すべてのライセンス</option>
    </select>
    <span id="count" style="opacity:.7;margin-left:auto">0 items</span>
  </div>
  <div id="quickTags" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap"></div>
</div>

<div id="list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px"></div>
<nav style="display:flex;gap:8px;justify-content:center;align-items:center;margin:16px 0">
  <button id="prev">← 前へ</button>
  <span id="pageInfo" style="opacity:.7"></span>
  <button id="next">次へ →</button>
</nav>

<script>
(async function(){
  const res = await fetch('{{ "/resources.json" | relative_url }}', {cache:'no-store'});
  const data = await res.json();

  const q = document.getElementById('q');
  const sortSel = document.getElementById('sort');
  const typeSel = document.getElementById('type');
  const licenseSel = document.getElementById('license');
  const quick = document.getElementById('quickTags');
  const list = document.getElementById('list');
  const count = document.getElementById('count');
  const prev = document.getElementById('prev');
  const next = document.getElementById('next');
  const pageInfo = document.getElementById('pageInfo');

  const PAGE = 48;
  let page = 1;
  let activeTags = new Set();

  const esc = s => (s||'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const toDate = s => s ? (s+'').slice(0,10) : '';

  function topNTags(n=20){
    const freq = new Map();
    for(const x of data) for(const t of (x.tags||[])){ const k=(t||'').trim(); if(k) freq.set(k,(freq.get(k)||0)+1); }
    return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n).map(([k])=>k);
  }
  function uniqueLicenses(){
    const s = new Set(); for(const x of data){ const v=(x.license||'').trim(); if(v) s.add(v); }
    return [...s].sort((a,b)=>a.localeCompare(b));
  }
  function buildQuick(){
    quick.innerHTML = topNTags().map(t=>`<a href="#" class="pill" data-t="${esc(t)}" style="border:1px solid #e5e5e5;border-radius:999px;padding:4px 10px">${esc(t)}</a>`).join('');
    quick.addEventListener('click', e=>{
      const a = e.target.closest('a[data-t]'); if(!a) return; e.preventDefault();
      const t = a.dataset.t;
      if(activeTags.has(t)){ activeTags.delete(t); a.style.background=''; }
      else{ activeTags.add(t); a.style.background='#eef4ff'; }
      page=1; render();
      if (window.plausible) plausible('tag_click', {props:{tag:t}});
    });
  }
  function buildLicenses(){
    const opts = uniqueLicenses();
    licenseSel.innerHTML = '<option value="">すべてのライセンス</option>' + opts.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join('');
  }

  function apply(){
    const query = (q.value||'').toLowerCase().trim();
    const type = typeSel.value;
    const lic = licenseSel.value;

    let arr = data.slice();
    if(query){
      arr = arr.filter(x=>{
        const hay = [x.title||'', x.short_desc||'', (x.tags||[]).join(','), x.license||''].join('\n').toLowerCase();
        return hay.includes(query);
      });
    }
    if(type) arr = arr.filter(x=> (x.source_type||'')===type);
    if(lic) arr = arr.filter(x=> (x.license||'')===lic);
    if(activeTags.size){
      arr = arr.filter(x=>{
        const s = new Set(x.tags||[]);
        for(const t of activeTags) if(!s.has(t)) return false;
        return true;
      });
    }

    const sorter = {
      'score-desc': (a,b)=> (b.score||0)-(a.score||0),
      'score-asc':  (a,b)=> (a.score||0)-(b.score||0),
      'date-desc':  (a,b)=> (b.updated_at||'').localeCompare(a.updated_at||''),
      'date-asc':   (a,b)=> (a.updated_at||'').localeCompare(b.updated_at||''),
      'title-asc':  (a,b)=> (a.title||'').localeCompare(b.title||''),
      'title-desc': (a,b)=> (b.title||'').localeCompare(a.title||'')
    }[sortSel.value] || ((a,b)=>0);
    arr.sort(sorter);
    return arr;
  }

  function render(){
    const arr = apply();
    const total = arr.length;
    const pages = Math.max(1, Math.ceil(total/PAGE));
    page = Math.min(Math.max(1,page), pages);
    const slice = arr.slice((page-1)*PAGE, (page)*PAGE);

    count.textContent = `${total.toLocaleString()} items`;
    pageInfo.textContent = `${page} / ${pages} ページ`;

    list.innerHTML = slice.map(x=>`
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
          <b>${esc(x.title||'')}</b>
          <span style="opacity:.7;border:1px solid #e5e5e5;border-radius:999px;padding:2px 8px">${esc(x.source_type||'')}</span>
        </div>
        <div style="opacity:.7;margin-top:2px">score: ${x.score ?? '-'} ・ 更新: ${esc(toDate(x.updated_at))} ${x.license?`・ lic: ${esc(x.license)}`:''}</div>
        <div style="margin-top:6px">${esc(x.short_desc||'')}</div>
        <div style="margin-top:6px">${(x.tags||[]).slice(0,12).map(t=>`<span style="border:1px solid #e5e5e5;border-radius:999px;padding:2px 8px;margin:0 4px 4px 0;display:inline-block">${esc(t)}</span>`).join('')}</div>
        <div style="margin-top:8px">
          <a class="open-link" href="${esc(x.url||'#')}" target="_blank" rel="noopener">Open</a>
        </div>
      </div>
    `).join('');

    prev.disabled = (page<=1);
    next.disabled = (page>=pages);
  }

  function sendSearch(){
    const qv = q.value.trim();
    if(!qv) return;
    if (window.plausible) plausible('search', {props:{ q:qv, results: apply().length }});
  }

  q.addEventListener('input', ()=>{ page=1; render(); setTimeout(sendSearch, 600); });
  sortSel.addEventListener('change', ()=>{ page=1; render(); });
  typeSel.addEventListener('change', ()=>{ page=1; render(); });
  licenseSel.addEventListener('change', ()=>{ page=1; render(); });
  prev.addEventListener('click', ()=>{ page--; render(); });
  next.addEventListener('click', ()=>{ page++; render(); });

  buildQuick(); buildLicenses(); render();
})();
</script>