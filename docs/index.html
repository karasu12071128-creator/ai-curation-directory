<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>AI Curation Directory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- SEO（必要なら適宜編集） -->
  <meta name="description" content="Hugging Face と GitHub の人気AIリソースを毎日自動更新。検索・タグ・スコアで素早く発見。">
  <link rel="preload" href="resources.json" as="fetch" crossorigin="anonymous">
  <style>
    :root{--fg:#222;--muted:#666;--bd:#e5e5e5;--bg:#fff}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;margin:24px;line-height:1.6;color:var(--fg);background:var(--bg)}
    header,footer{opacity:.85;font-size:.95rem}
    h1{margin:0 0 4px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:12px 0}
    input,select{padding:8px;border:1px solid var(--bd);border-radius:6px}
    .btn{padding:8px 10px;border:1px solid var(--bd);border-radius:6px;background:#fafafa;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:12px}
    .card{border:1px solid var(--bd);border-radius:10px;padding:12px}
    .card b{font-size:1.02rem}
    .muted{color:var(--muted)}
    .tags{margin-top:6px;font-size:.9rem;color:#333}
    .tags small{border:1px solid var(--bd);border-radius:999px;padding:2px 8px;margin:0 4px 4px 0;display:inline-block}
    .row{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .pill{border:1px solid var(--bd);border-radius:999px;padding:2px 8px}
    nav.pager{display:flex;gap:6px;align-items:center;justify-content:center;margin:16px 0}
    nav.pager .btn[disabled]{opacity:.4;cursor:not-allowed}
    .right{margin-left:auto}
    a{color:#1a73e8;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div>
      <h1>AI Curation Directory</h1>
      <div class="muted">Auto-updating directory of AI resources（毎日自動更新）</div>
    </div>
    <div class="right">
      <a class="btn" href="resources.csv" download>CSV（サンプル）</a>
    </div>
  </div>

  <div class="toolbar">
    <input id="q" placeholder="キーワード / tag（例: diffusion, llm）" size="32" />
    <select id="sort">
      <option value="score-desc">スコア高い順</option>
      <option value="score-asc">スコア低い順</option>
      <option value="date-desc">更新が新しい順</option>
      <option value="date-asc">更新が古い順</option>
      <option value="title-asc">タイトルA→Z</option>
      <option value="title-desc">タイトルZ→A</option>
    </select>
    <select id="type">
      <option value="">すべての種類</option>
      <option value="hf_model">hf_model</option>
      <option value="hf_space">hf_space</option>
      <option value="gh_repo">gh_repo</option>
    </select>
    <span id="count" class="pill muted">0 items</span>
  </div>
</header>

<main>
  <div id="list" class="grid" aria-live="polite"></div>
  <nav class="pager">
    <button class="btn" id="prev">← 前へ</button>
    <span id="pageInfo" class="muted"></span>
    <button class="btn" id="next">次へ →</button>
  </nav>
</main>

<footer>
  <hr>
  <div class="muted">最終スナップショットは <code>/docs/resources.json</code> に保存されます。</div>
</footer>

<script>
(async function(){
  const res = await fetch('resources.json',{cache:'no-store'});
  const data = await res.json();

  // ---------- elements ----------
  const q = document.getElementById('q');
  const sortSel = document.getElementById('sort');
  const typeSel = document.getElementById('type');
  const list = document.getElementById('list');
  const count = document.getElementById('count');
  const prev = document.getElementById('prev');
  const next = document.getElementById('next');
  const pageInfo = document.getElementById('pageInfo');

  // ---------- state ----------
  const PAGE = 48; // 1ページ表示件数
  let page = 1;

  function esc(s){return (s||'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
  function toDateStr(s){ if(!s) return ''; return (s+'').slice(0,10); }

  function applyFilters(){
    const query = (q.value||'').toLowerCase().trim();
    const type = typeSel.value;

    let arr = data.slice();

    if (query) {
      arr = arr.filter(x=>{
        const hay = [
          x.title||'',
          x.short_desc||'',
          (x.tags||[]).join(',')
        ].join('\n').toLowerCase();
        return hay.includes(query);
      });
    }
    if (type) arr = arr.filter(x=> (x.source_type||'') === type);

    // sort
    const s = sortSel.value;
    const by = {
      'score-desc': (a,b)=> (b.score||0) - (a.score||0),
      'score-asc':  (a,b)=> (a.score||0) - (b.score||0),
      'date-desc':  (a,b)=> (b.updated_at||'').localeCompare(a.updated_at||''),
      'date-asc':   (a,b)=> (a.updated_at||'').localeCompare(b.updated_at||''),
      'title-asc':  (a,b)=> (a.title||'').localeCompare(b.title||''),
      'title-desc': (a,b)=> (b.title||'').localeCompare(a.title||'')
    }[s] || ((a,b)=>0);
    arr.sort(by);

    return arr;
  }

  function render(){
    const arr = applyFilters();
    const total = arr.length;
    const pages = Math.max(1, Math.ceil(total / PAGE));
    if (page > pages) page = pages;
    if (page < 1) page = 1;
    const start = (page-1)*PAGE;
    const slice = arr.slice(start, start + PAGE);

    count.textContent = `${total.toLocaleString()} items`;
    pageInfo.textContent = `${page} / ${pages} ページ`;

    list.innerHTML = slice.map(x=>`
      <div class="card">
        <div class="row">
          <b>${esc(x.title||'')}</b>
          <span class="pill muted">${esc(x.source_type||'–')}</span>
        </div>
        <div class="muted" style="margin-top:2px">score: ${x.score ?? '-' }・更新: ${esc(toDateStr(x.updated_at))}</div>
        <div style="margin-top:6px">${esc(x.short_desc||'')}</div>
        <div class="tags">
          ${(x.tags||[]).slice(0,12).map(t=>`<small>${esc(t)}</small>`).join('')}
        </div>
        <div style="margin-top:8px">
          <a href="${esc(x.url||'#')}" target="_blank" rel="noopener">Open</a>
        </div>
      </div>
    `).join('');
    prev.disabled = (page<=1);
    next.disabled = (page>=pages);
  }

  // events
  q.addEventListener('input', ()=>{ page=1; render(); });
  sortSel.addEventListener('change', ()=>{ page=1; render(); });
  typeSel.addEventListener('change', ()=>{ page=1; render(); });
  prev.addEventListener('click', ()=>{ page--; render(); });
  next.addEventListener('click', ()=>{ page++; render(); });

  render();
})();
</script>
</body>
</html>